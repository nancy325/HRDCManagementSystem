@model HRDCManagementSystem.Models.ViewModels.TrainingViewModel

@{
    ViewData["Title"] = "Training Details";
}

<div class="container mt-4">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <h2 class="mb-3">@Model.Title</h2>
    <dl class="row">
        <dt class="col-sm-3">Trainer</dt>
        <dd class="col-sm-9">@Model.TrainerName</dd>

        <dt class="col-sm-3">Dates</dt>
        <dd class="col-sm-9">
            @Html.DisplayFor(m => m.StartDate) - @Html.DisplayFor(m => m.EndDate)
        </dd>

        <dt class="col-sm-3">Time</dt>
        <dd class="col-sm-9">
            @Html.DisplayFor(m => m.FromTime) - @Html.DisplayFor(m => m.ToTime)
        </dd>

        <dt class="col-sm-3">Registration Valid Till</dt>
        <dd class="col-sm-9">
            @Html.DisplayFor(m => m.ValidTill)
        </dd>

        <dt class="col-sm-3">Venue</dt>
        <dd class="col-sm-9">@Model.Venue</dd>

        <dt class="col-sm-3">Mode</dt>
        <dd class="col-sm-9">@Model.Mode</dd>

        <dt class="col-sm-3">Capacity</dt>
        <dd class="col-sm-9">@Model.Capacity</dd>

        <dt class="col-sm-3">Current Registrations</dt>
        <dd class="col-sm-9">@ViewBag.CurrentRegistrations / @Model.Capacity</dd>

        <dt class="col-sm-3">Status</dt>
        <dd class="col-sm-9">@Model.Status</dd>

        <dt class="col-sm-3">File</dt>
        <dd class="col-sm-9">
            @if (!string.IsNullOrEmpty(Model.ExistingPath))
            {
                <a href="@Url.Content(Model.ExistingPath)" target="_blank">View File</a>
            }
            else
            {
                <span>No file uploaded.</span>
            }
        </dd>
    </dl>

    <div class="mt-3">
        @if (User.IsInRole("Employee"))
        {
            if (ViewBag.IsRegistered == true)
            {
                <div class="alert alert-info">
                    <i class="fas fa-check-circle"></i> You are already registered for this training.
                </div>
            }
            else
            {
                
                    var currentDate = DateOnly.FromDateTime(DateTime.Now);
                    var canRegister = (!Model.ValidTill.HasValue) || (Model.ValidTill >= currentDate);
                    var hasCapacity = (ViewBag.CurrentRegistrations < Model.Capacity);

                    if (canRegister && hasCapacity)
                    {
                        <form asp-action="Register" asp-controller="TrainingRegistration" method="post" class="d-inline">
                            <input type="hidden" name="trainingId" value="@Model.TrainingSysID" />
                            <button type="submit" class="btn btn-success" onclick="return confirm('Are you sure you want to register for this training?')">
                                <i class="fas fa-user-plus"></i> Register for Training
                            </button>
                        </form>
                    }
                    else if (!canRegister)
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Registration period has expired for this training.
                        </div>
                    }
                    else if (!hasCapacity)
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> This training is full. No more registrations are accepted.
                        </div>
                    }
                
            }
        }

        @if (User.IsInRole("Admin"))
        {
            <a asp-action="EditTraining" asp-route-id="@Model.TrainingSysID" class="btn btn-warning">Edit</a>
        }

        <a asp-action="TrainingIndex" class="btn btn-secondary">Back</a>
    </div>
</div>
